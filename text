pipeline {
    agent any
    parameters {
        string(name: 'GITLAB_TAG', defaultValue: 'v1.0.0', description: 'GitLab Tag for Deployment')
    }
    environment {
        OCP_NAMESPACE = "my-namespace"  // 修改為你的 OCP 命名空間
        DEPLOYMENT_FILE = "deployment.yaml"
    }
    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://gitlab.com/your-repo.git'
            }
        }
        stage('Update YAML with GitLab Tag') {
            steps {
                script {
                    def yamlContent = readFile("${DEPLOYMENT_FILE}")
                    yamlContent = yamlContent.replaceAll("IMAGE_TAG_PLACEHOLDER", "${params.GITLAB_TAG}")
                    writeFile file: "${DEPLOYMENT_FILE}", text: yamlContent
                }
            }
        }
        stage('Deploy to OpenShift') {
            steps {
                script {
                    sh """
                        oc login --token=your-token --server=https://your-ocp-cluster:6443
                        oc project ${OCP_NAMESPACE}
                        oc apply -f ${DEPLOYMENT_FILE}
                        oc rollout restart deployment my-app
                    """
                }
            }
        }
    }
}
